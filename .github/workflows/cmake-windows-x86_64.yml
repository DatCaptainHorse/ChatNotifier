name: Build Windows x64

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:


env:
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      with:
        vs-prerelease: true
        msbuild-architecture: x64

    - name: Install Python
      run: |
        Invoke-WebRequest -Uri "https://www.python.org/ftp/python/3.12.4/python-3.12.4-amd64.exe" -OutFile "python-3.12.4-amd64.exe"
        Start-Process -Wait -FilePath "python-3.12.4-amd64.exe" -ArgumentList "/quiet InstallAllUsers=1 PrependPath=1"
        Remove-Item -Path "python-3.12.4-amd64.exe"

    - name: Set up Clang
      uses: egor-tensin/setup-clang@v1
      with:
        version: 18
        platform: x64

    - uses: lukka/get-cmake@latest

    - name: Configure CMake
      env:
        TWITCH_CLIENT_SECRET: ${{ secrets.TwitchClientSecret }}
      run: cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DCMAKE_C_COMPILER=clang-cl -DCMAKE_CXX_COMPILER=clang-cl

    - name: Build
      env:
        TWITCH_CLIENT_SECRET: ${{ secrets.TwitchClientSecret }}
      run: cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}} --verbose

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ChatNotifier
        path: ${{github.workspace}}/build/bin/
